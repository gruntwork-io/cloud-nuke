# Reusable workflow for nuking resources in a single AWS account.
# Called by nuke-phxdevops.yml, nuke-configtests.yml, nuke-sandbox.yml, etc.
name: Nuke Account

on:
  workflow_call:
    inputs:
      account_name:
        required: true
        type: string
      role_arn:
        required: true
        type: string
      older_than:
        required: true
        type: string
      extra_excludes:
        required: false
        type: string
        default: ''

env:
  MISE_VERSION: '2025.12.10'
  # Resources excluded across all accounts to prevent breaking infrastructure
  COMMON_EXCLUDES: >-
    --exclude-resource-type iam
    --exclude-resource-type iam-group
    --exclude-resource-type iam-policy
    --exclude-resource-type iam-role
    --exclude-resource-type iam-service-linked-role
    --exclude-resource-type oidcprovider
    --exclude-resource-type route53-hosted-zone
    --exclude-resource-type route53-cidr-collection
    --exclude-resource-type route53-traffic-policy
    --exclude-resource-type ecr
    --exclude-resource-type config-rules
    --exclude-resource-type nat-gateway
    --exclude-resource-type ec2-subnet

jobs:
  nuke:
    name: "${{ inputs.account_name }}: ${{ matrix.region }}"
    runs-on: ubuntu-latest
    timeout-minutes: ${{ matrix.region == 'global' && 30 || 60 }}
    strategy:
      fail-fast: false
      matrix:
        region:
          - global
          - ap-northeast-1
          - ap-northeast-2
          - ap-northeast-3
          - ap-south-1
          - ap-southeast-1
          - ap-southeast-2
          - ca-central-1
          - eu-central-1
          - eu-north-1
          - eu-west-1
          - eu-west-2
          - eu-west-3
          # - me-central-1  # Opt-in region, not enabled in all accounts
          - sa-east-1
          - us-east-1
          - us-east-2
          - us-west-1
          - us-west-2
    steps:
      - uses: actions/checkout@v4
      - uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ inputs.role_arn }}
          aws-region: ${{ matrix.region == 'global' && 'us-east-1' || matrix.region }}
      - uses: jdx/mise-action@v3
        with:
          version: ${{ env.MISE_VERSION }}
          experimental: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - uses: actions/cache@v4
        with:
          path: |
            ~/go/pkg/mod
            ~/.cache/go-build
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: ${{ runner.os }}-go-
      - run: go mod download
      - name: Nuke ${{ matrix.region }}
        env:
          DISABLE_TELEMETRY: true
        run: |
          set +e
          go run -ldflags="-X 'main.VERSION=${{ github.sha }}'" main.go aws \
            --older-than ${{ inputs.older_than }} --force --config ./.github/nuke_config.yml \
            --region ${{ matrix.region }} ${{ env.COMMON_EXCLUDES }} ${{ inputs.extra_excludes }} \
            --delete-unaliased-kms-keys --log-level info \
            --output-format json --output-file /tmp/nuke-${{ matrix.region }}.json 2>&1 | tee /tmp/nuke-${{ matrix.region }}.log
          EXIT_CODE=${PIPESTATUS[0]}
          exit $EXIT_CODE
      - name: Upload results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.account_name }}-${{ matrix.region }}
          path: |
            /tmp/nuke-${{ matrix.region }}.log
            /tmp/nuke-${{ matrix.region }}.json
          retention-days: 7

  # Aggregate results and send Slack notification
  notify:
    name: "${{ inputs.account_name }}: Notify"
    runs-on: ubuntu-latest
    if: always()
    needs: [nuke]
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: ${{ inputs.account_name }}-*
          path: /tmp/logs
          merge-multiple: true
        continue-on-error: true
      - name: Aggregate and notify
        env:
          WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          NL=$'\n'

          # Aggregate counts from all JSON files into a temp file for sorting
          TOTAL_DELETED=0
          TOTAL_FAILED=0
          REGION_DATA=$(mktemp)
          while IFS= read -r json_file; do
            if [ -f "$json_file" ]; then
              REGION=$(basename "$json_file" .json | sed 's/^nuke-//')
              DELETED=$(jq -r '.summary.deleted // 0' "$json_file")
              FAILED=$(jq -r '.summary.failed // 0' "$json_file")
              TOTAL_DELETED=$((TOTAL_DELETED + DELETED))
              TOTAL_FAILED=$((TOTAL_FAILED + FAILED))
              if [ "$DELETED" -gt 0 ] || [ "$FAILED" -gt 0 ]; then
                echo "${DELETED} ${FAILED} ${REGION}" >> "$REGION_DATA"
              fi
            fi
          done < <(find /tmp/logs -name "*.json" 2>/dev/null | sort)

          # Sort regions: those with deletions first, then by failure count descending
          # Take top 5 most active regions
          TOP_REGIONS=""
          SHOWN=0
          REMAINING_COUNT=0
          REMAINING_DELETED=0
          REMAINING_FAILED=0
          while IFS=' ' read -r DEL FAIL REG; do
            if [ "$SHOWN" -lt 5 ]; then
              TOP_REGIONS="${TOP_REGIONS}${NL}â€¢ ${REG}: deleted ${DEL}, failed ${FAIL}"
              SHOWN=$((SHOWN + 1))
            else
              REMAINING_COUNT=$((REMAINING_COUNT + 1))
              REMAINING_DELETED=$((REMAINING_DELETED + DEL))
              REMAINING_FAILED=$((REMAINING_FAILED + FAIL))
            fi
          done < <(sort -k2,2nr "$REGION_DATA")
          rm -f "$REGION_DATA"

          if [ "${{ needs.nuke.result }}" == "success" ]; then
            STATUS=":white_check_mark: Success"
            COLOR="good"
          else
            STATUS=":x: Failed"
            COLOR="danger"
          fi

          MSG="*${{ inputs.account_name }} Nuke*: ${STATUS}"
          MSG="${MSG}${NL}Deleted: ${TOTAL_DELETED:-0} | Failed: ${TOTAL_FAILED:-0}"
          if [ -n "$TOP_REGIONS" ]; then
            MSG="${MSG}${TOP_REGIONS}"
          fi
          if [ "$REMAINING_COUNT" -gt 0 ]; then
            MSG="${MSG}${NL}_+ ${REMAINING_COUNT} other regions: deleted ${REMAINING_DELETED}, failed ${REMAINING_FAILED}_"
          fi
          MSG="${MSG}${NL}<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Run>"

          PAYLOAD=$(jq -n \
            --arg color "$COLOR" \
            --arg text "$MSG" \
            '{attachments: [{color: $color, blocks: [{type: "section", text: {type: "mrkdwn", text: $text}}]}]}')

          curl -sS -X POST "$WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -d "$PAYLOAD"
