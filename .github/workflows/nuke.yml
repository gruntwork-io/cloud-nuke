name: Scheduled Nuke

on:
  schedule:
    - cron: '0 */3 * * *'  # Every 3 hours (phxdevops, configtests)
    - cron: '0 0 * * *'    # Nightly at midnight UTC (sandbox)
  workflow_dispatch:
    inputs:
      account:
        description: 'Target account (leave empty for scheduled jobs)'
        required: false
        type: choice
        options:
          - ''
          - phxdevops
          - configtests
          - sandbox

permissions:
  id-token: write
  contents: read

jobs:
  # ============================================
  # PhxDevOps Account - Every 3 hours
  # ============================================
  phxdevops:
    if: |
      github.event_name == 'workflow_dispatch' && (inputs.account == 'phxdevops' || inputs.account == '') ||
      github.event_name == 'schedule' && github.event.schedule == '0 */3 * * *'
    uses: ./.github/workflows/nuke-account.yml
    with:
      account_name: PhxDevOps
      role_arn: arn:aws:iam::087285199408:role/cloud-nuke-gha
      older_than: 2h
    secrets: inherit

  # ============================================
  # ConfigTests Account - Every 3 hours
  # ============================================
  configtests:
    if: |
      github.event_name == 'workflow_dispatch' && (inputs.account == 'configtests' || inputs.account == '') ||
      github.event_name == 'schedule' && github.event.schedule == '0 */3 * * *'
    uses: ./.github/workflows/nuke-account.yml
    with:
      account_name: ConfigTests
      role_arn: arn:aws:iam::677276116620:role/cloud-nuke-gha
      older_than: 2h
      extra_excludes: --exclude-resource-type internet-gateway
    secrets: inherit

  # ============================================
  # Sandbox Account - Nightly
  # ============================================
  sandbox:
    if: |
      github.event_name == 'workflow_dispatch' && (inputs.account == 'sandbox' || inputs.account == '') ||
      github.event_name == 'schedule' && github.event.schedule == '0 0 * * *'
    uses: ./.github/workflows/nuke-account.yml
    with:
      account_name: Sandbox
      role_arn: arn:aws:iam::738755648600:role/cloud-nuke-gha
      older_than: 24h
      extra_excludes: --exclude-resource-type eip
    secrets: inherit
